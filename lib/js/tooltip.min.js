define(["require","exports","module","jquery","underscore","css!../css/tooltip"],function(a,b,c){"use strict";function g(a,b){return(b?".":"")+"ce-tooltip"+(a?"-"+a:"")}function p(a,b,c){this._options=d.extend({},f,b||{}),++m,a.hasClass(i)||(this.element=d(a),this.tooltip=d([]),this.id=this._options.id||m,n[this.id]=this,this.stateIsActive=!1,this._mode=c||"default",this._memory={},this._lock={},this.idString=g(this.id),this.isMode("fixed")&&(this.setOption("eventShow","click"),this.setOption("isClosed",!0),this.lock("onClose",!1),this.lock("onHide",!0),this.lock("onLeave",!0),this.lock("onOver",!0)),this.isMode("constant")&&(this.setOption("isClosed",!0),this.lock("onClose",!1),this.lock("onShow",!0),this.lock("onHide",!0),this.lock("onLeave",!0),this.lock("onOver",!0)),this._setMark(),this._bindElement(),this.isMode("constant")&&this.show())}function q(a){var c,b=!1;return a.hasClass(h)?b=a.attr(k):a.hasClass(i)?b=a.attr(j):(c=a.closest("."+h),c.length?b=c.attr(k):(c=a.closest("."+i),b=c.length?c.attr(j):!1)),b}var d=a("jquery"),e=a("underscore");a("css!../css/tooltip");var f={message:"",theme:"default",size:"default",position:"bottom right",closeText:"&times;",zIndex:9901,style:"",message_css:{},animation:!0,animationSpeed:300,animationDelay:200,ajaxUrl:"",ajaxData:"",ajaxOnComplete:function(){},ajaxPreResponse:function(a){return a},isClosed:!1,eventShow:"mouseenter",eventHide:"mouseleave",eventClose:"click",onShow:function(){},onHide:function(){},onClose:function(){},onLeave:function(){},onOver:function(){}},h=g(),i=g("init"),j="data-tooltip_id",k="data-tooltip_selfid",l=!1,m=0,n={},o={};p.prototype={update:function(a){this.tooltip.length&&"object"==typeof a&&a.message&&this.getElement("message").html(a.message)},getOption:function(a){if(void 0===a)throw new Error("option NAME is UNDEFINED!");if(void 0===this._options[a])throw new Error("options['"+a+"'] is UNDEFINED!");if("position"===a&&"string"==typeof this._options.position){var b=this._options.position;if(void 0===o[b]){var c=b.split(" "),d=c[0];c[0]=c[1]?c[0]:"bottom",c[1]=c[1]||d,c[0]=c[0]&&c[0].match(/(top|right|bottom|left)/)?c[0]:"bottom",c[1]=c[1]&&c[1].match(/(top|right|bottom|left|center|middle)/)?c[1]:"center",o[b]={orient:c[0].charAt(0),point:c[1].charAt(0)}}this._options.position=o[b]}return this._options[a]},init:function(){this.tooltip.length||(this._create(),this._bindTooltip())},isMode:function(a){return this._mode===a},setOption:function(a,b){if(void 0===this._options[a])throw new Error('setOption["'+a+'"] is UNDEFINED');this._options[a]=b},lock:function(a,b){return void 0!==b&&(this._lock[a]=!!b),!!this._lock[a]},log:function(a){l&&console.log("Tooltip #",this.id," : ",a)},getElement:function(a){return a?void 0!==this._memory[a]?this._memory[a]:(this._memory[a]=this.getElement().find(g(a,1)),this._memory[a]):this.tooltip},getIdString:function(){return this.idString},_setMark:function(){this.element.length&&(this.element.attr(j,this.id),this.element.addClass(i))},_unsetMark:function(){this.element.length&&(this.element.removeAttr(j),this.element.removeClass(i))},_actionCallback:function(a,b){if(this.lock(a))return this.log(a+" was LOCKED !"),!1;var d,c=this.getOption(a);if(e.isFunction(c))d=c(this,a);else if(e.isString(c))if(/\./.test(c)){var f=c.split(".");e.isFunction(window[f[0]][f[1]])&&(d=window[f[0]][f[1]].call(window[f[0]],this,a))}else e.isFunction(window[c])&&(d=window[c](this,a));return this.log(a+" callback : "+d),(d||null==d)&&b.call(this,a),d},show:function(){if(this.init(),this.tooltip.length&&!this.stateIsActive){var a=this,b={display:"block",zIndex:this.getOption("zIndex")};this.isMode("constant")&&(b.opacity=.01),a.refresh(),this.getElement().css(b),this.getElement().stop(1,1).delay(this.getOption("animationDelay")).fadeTo(this.getOption("animationSpeed"),1,function(){a.refresh(),a.stateIsActive=!0})}},hide:function(){if(this.tooltip.length){var a=this;this.getElement().delay(this.getOption("animationDelay")).stop(1,0).fadeTo(this.getOption("animationSpeed"),0,function(){a.getElement().css({zIndex:a.getOption("zIndex")/2,left:-1e3}),a.stateIsActive=!1})}},over:function(){this.tooltip.length&&this.getElement().stop(1,0).fadeTo(0,1)},ajaxLoad:function(a,b,c){if(!this.lock("ajax")){var f=this;a=a||this.getOption("ajaxUrl"),a&&(b=b||this.getOption("ajaxData")||"",c=c||this.getOption("ajaxOnComplete"),this.log("ajaxUrl: "+a),this.log("ajaxData: "+b),d.ajax({type:"POST",dataType:"html",url:a,data:b,beforeSend:function(){f.lock("ajax",!0)},success:function(a){var b=a,c=window[f.getOption("ajaxPreResponse")];e.isFunction(c)&&(b=c.call(window,a,f.tooltip,f.element)),b!==!1&&(a=b,f.getElement("message").html(a)),f.refresh()},complete:function(){c(f)}}))}},actionShow:function(){this._actionCallback("onShow",function(){this.getOption("ajaxUrl")&&this.ajaxLoad(),this.show()})},actionHide:function(){this._actionCallback("onHide",this.hide)},actionClose:function(){this._actionCallback("onClose",function(){this.isMode("constant")||this.isMode("fixed")?this.hide():this.actionHide()})},actionOver:function(){this._actionCallback("onOver",this.over)},actionLeave:function(){this._actionCallback("onLeave",this.hide)},refresh:function(){if(this.tooltip.length){var a=this.element,b=this.getElement(),c={height:b.height(),width:b.width()},d=a.offset(),f={height:e.isNumber(a.outerHeight())?a.outerHeight():a.height(),width:e.isNumber(a.outerWidth())?a.outerWidth():a.width(),top:d.top,left:d.left},h={};switch(this.getOption("position").orient){case"t":h.top=f.top-c.height;break;case"b":h.top=f.top+f.height;break;case"l":h.left=f.left-c.width;break;case"r":h.left=f.left+f.width}switch(this.getOption("position").point){case"r":h.left=f.left+f.width/2;break;case"l":h.left=f.left+f.width/2-c.width;break;case"c":h.left=f.left-(c.width-f.width)/2;break;case"m":h.top=f.top-(c.height-f.height)/2;break;case"t":h.top=f.top-c.height+f.height/2;break;case"b":h.top=f.top+f.height/2}this._replaceClasses(this.getElement(),/ce-tooltip-(t|r|b|l)-(t|r|b|l|c|m)/g,g("p-"+this.getOption("position").orient+this.getOption("position").point)),b.css(h)}},_replaceClasses:function(a,b,c){a.attr("class",a.attr("class").replace(b,c))},_create:function(){if(!this.tooltip.length){var a=h+" ce-theme-"+this.getOption("theme")+" "+g("size-"+this.getOption("size"))+" "+g(this.getOption("position").orient+this.getOption("position").point)+(this.getOption("isClosed")?" "+g("closed"):"");d("body").append('<div id="'+this.getIdString()+'" '+k+'="'+this.id+'" class="'+a+'" style="'+this.getOption("style")+'">'+'<div class="'+g("block")+'">'+'<span class="ceb_tr1 ceb_tr"></span>'+'<span class="ceb_tr2 ceb_tr"></span>'+'<div class="'+g("message")+'">'+this.getOption("message")+"</div>"+'<div class="'+g("close")+'">'+this.getOption("closeText")+"</div>"+"</div>"+"</div>"),this.tooltip=d("#"+this.getIdString());var b=this.getOption("message_css");b&&this.getElement("message").css(b)}},_bindElement:function(){if(this.element.length){var a=this;this._unbindElement(),this.element.on(this.getOption("eventShow")+".tooltip",function(){a.actionShow()}),this.element.children().on(this.getOption("eventShow")+".tooltip",function(){a.actionShow()}),this.element.on(this.getOption("eventHide")+".tooltip",function(){a.actionHide()})}},_bindTooltip:function(){if(this.tooltip.length){var a=this;this._unbindTooltip(),this.getElement().on("mouseenter.tooltip",function(){a.actionOver()}),this.getElement().on("mouseleave.tooltip",function(){a.actionLeave()}),this.getElement("close").on(this.getOption("eventClose")+".tooltip",function(){a.actionClose()})}},_unbindElement:function(){this.element.length&&(this.element.unbind(".tooltip"),this.element.children().unbind(".tooltip"))},_unbindTooltip:function(){this.tooltip.length&&(this.getElement().unbind(".tooltip"),this.getElement("close").unbind(".tooltip"))},remove:function(){this.detach(),this.tooltip.remove()},detach:function(){this._unbindElement(),this._unbindTooltip(),this._unsetMark(),this.lock=function(){return!0}}};var r=null,s=function(){if(r)return r;var a=new p(d([]));return a.detach(),r=a,a};return d.fn.ceTooltip=function(a){var b=d(this);if(!b.length)return s();if(arguments.length)return a.message=a.message||"",this.each(function(){var b=d(this);b.hasClass(i)||new p(b,a)});var c=q(b.eq(0));return c?n[c]:s()},c.exports=p,c.exports}); 
